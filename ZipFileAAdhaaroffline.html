<!DOCTYPE html>
<html lang="en">
     <head>
          <meta charset="UTF-8" />
          <meta name="viewport" content="width=device-width, initial-scale=1.0" />
          <title>Extract Aadhaar Data</title>
          <link
               href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
               rel="stylesheet"
          />
          <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
          <script src="https://cdn.jsdelivr.net/npm/@zip.js/zip.js@2.7.24/dist/zip.min.js"></script>
          <script src="https://cdnjs.cloudflare.com/ajax/libs/crypto-js/4.1.1/crypto-js.min.js"></script>
          <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
     </head>
     <body class="bg-light">
          <div class="container mt-5">
               <div class="card shadow-lg border-0">
                    <div class="card-header bg-primary text-white text-center">
                         <h4><i class="bi bi-upload"></i> Upload Aadhaar ZIP File</h4>
                    </div>
                    <div class="card-body">
                         <div class="mb-3">
                              <input type="file" class="form-control" id="zipFileInput" />
                         </div>
                         <div class="mb-3">
                              <input
                                   type="password"
                                   class="form-control"
                                   id="zipPassword"
                                   placeholder="Enter ZIP Password"
                              />
                         </div>
                         <button class="btn btn-primary w-100" onclick="extractAndProcessXML()">
                              <i class="bi bi-file-earmark-zip"></i> Extract & Process
                         </button>
                         <div id="output" class="mt-4"></div>
                    </div>
               </div>
          </div>

          <script>
               async function extractAndProcessXML() {
                    const zipFileInput = document.getElementById("zipFileInput").files[0];
                    const password = document.getElementById("zipPassword").value;
                    const outputDiv = document.getElementById("output");

                    if (!zipFileInput) {
                         Swal.fire({ text: "Please select a ZIP file.", icon: "warning" });
                         return;
                    }

                    if (!password) {
                         Swal.fire({ text: "Please enter the ZIP password.", icon: "warning" });
                         return;
                    }

                    outputDiv.innerHTML =
                         '<div class="text-center"><div class="spinner-border text-primary"></div> Extracting...</div>';

                    try {
                         zip.configure({ useWebWorkers: false });

                         const reader = new zip.ZipReader(new zip.BlobReader(zipFileInput));
                         const entries = await reader.getEntries();

                         if (entries.length === 0) {
                              outputDiv.innerHTML = "Invalid ZIP file!";
                              return;
                         }

                         let xmlContent = "";
                         for (const entry of entries) {
                              if (!entry.directory && entry.filename.endsWith(".xml")) {
                                   const blob = await entry.getData(
                                        new zip.BlobWriter("text/xml"),
                                        { password: password }
                                   );
                                   xmlContent = await blob.text();
                                   break;
                              }
                         }

                         await reader.close();

                         if (!xmlContent) {
                              outputDiv.innerHTML = "No XML file found in the ZIP!";
                              return;
                         }

                         const data = processData(xmlContent);
                         if (data) {
                              displayData(data);
                         }
                    } catch (error) {
                         outputDiv.innerHTML = `<div class="alert alert-danger">Error extracting ZIP: ${error.message}</div>`;
                    }
               }

               function processData(xmlString) {
                    var parser = new DOMParser();
                    var xmlDoc = parser.parseFromString(xmlString, "text/xml");

                    var rootElement = xmlDoc.querySelector("OfflinePaperlessKyc");
                    var referenceId = rootElement
                         ? rootElement.getAttribute("referenceId") || "N/A"
                         : "N/A";

                    var poiElement = xmlDoc.querySelector("Poi");
                    var poaElement = xmlDoc.querySelector("Poa");
                    var uidDataElement = xmlDoc.querySelector("UidData");
                    var phtElement = xmlDoc.querySelector("Pht");

                    if (!poiElement || !poaElement || !uidDataElement || !phtElement) {
                         Swal.fire({ text: "XML structure is incomplete!", icon: "error" });
                         return false;
                    }

                    return {
                         referenceId,
                         poiName: poiElement.getAttribute("name") || "N/A",
                         dob: poiElement.getAttribute("dob") || "N/A",
                         gender: poiElement.getAttribute("gender") || "N/A",
                         mobileHash: poiElement.getAttribute("m") || "N/A",
                         poaHouse: poaElement.getAttribute("house") || "N/A",
                         poaStreet: poaElement.getAttribute("street") || "N/A",
                         poaDistrict: poaElement.getAttribute("dist") || "N/A",
                         poaState: poaElement.getAttribute("state") || "N/A",
                         poaPincode: poaElement.getAttribute("pc") || "N/A",
                         poaCountry: poaElement.getAttribute("country") || "N/A",
                         uid: uidDataElement.getAttribute("uid") || "N/A",
                         phtContent: phtElement.textContent || "",
                    };
               }

               function displayData(data) {
                    const outputDiv = document.getElementById("output");
                    outputDiv.innerHTML = `
                <div class="card shadow-lg border-0 mt-3">
                    <div class="card-header bg-success text-white text-center">
                        <h5><i class="bi bi-person-badge"></i> Aadhaar Details</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-3 text-center">
                                <img src="data:image/png;base64,${data.phtContent}" class="rounded-circle border img-fluid" alt="Photo" width="100">
                            </div>
                            <div class="col-md-9">
                                <p><strong>Reference ID:</strong> ${data.referenceId}</p>
                                <p><strong>Name:</strong> ${data.poiName}</p>
                                <p><strong>DOB:</strong> ${data.dob}</p>
                                <p><strong>Gender:</strong> ${data.gender}</p>
                                <p><strong>Mobile Hash:</strong> ${data.mobileHash}</p>
                            </div>
                        </div>
                        <hr>
                        <h5><i class="bi bi-geo-alt"></i> Address</h5>
                        <p><strong>House:</strong> ${data.poaHouse}</p>
                        <p><strong>Street:</strong> ${data.poaStreet}</p>
                        <p><strong>District:</strong> ${data.poaDistrict}</p>
                        <p><strong>State:</strong> ${data.poaState}</p>
                        <p><strong>Pincode:</strong> ${data.poaPincode}</p>
                        <p><strong>Country:</strong> ${data.poaCountry}</p>
                        <hr>
                        <h5><i class="bi bi-card-checklist"></i> UID</h5>
                        <p><strong>UID:</strong> ${data.uid}</p>
                    </div>
                </div>
            `;
               }
          </script>
     </body>
</html>
